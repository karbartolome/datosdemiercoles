#Librerías
library(readr)
library(dplyr)
library(ggplot2)
library(emojifont)

#Datos
estaciones <- readr::read_csv("https://raw.githubusercontent.com/cienciadedatos/datos-de-miercoles/master/datos/2019/2019-10-09/estaciones.csv",locale = readr::locale(encoding = "latin1"))
meteo <- readr::read_csv("https://raw.githubusercontent.com/cienciadedatos/datos-de-miercoles/master/datos/2019/2019-10-09/meteo.csv", na = "-99.9")

#mínimas temperaturas, máximas temperaturas y precipitación acumulada por estación
min_temps <- meteo %>% 
  dplyr::select (id_estacion,fecha,t=t_min) %>% 
  group_by(id_estacion) %>% 
  summarise(t = min(t, na.rm = TRUE))

max_temps <- meteo %>% 
  dplyr::select (id_estacion,fecha,t=t_max) %>% 
  group_by(id_estacion) %>% 
  summarise(t = max(t, na.rm = TRUE))

prec <- meteo %>% 
  dplyr::select (id_estacion,fecha,t=precipitacion) %>% 
  group_by(id_estacion) %>% 
  summarise(t = sum(t, na.rm = TRUE))

min_temps <- merge (min_temps,estaciones,by="id_estacion", all.x=TRUE, all.y=FALSE)
max_temps <- merge (max_temps,estaciones, by="id_estacion", all.x=TRUE, all.y=FALSE)
prec <- merge(prec,estaciones, by="id_estacion", all.x=TRUE, all.y=FALSE)

#Emojis 
min_temps$emoji <- emoji('snowflake')
min_temps$temp <- "min"
max_temps$emoji <- emoji('sunny')
max_temps$temp <- "max"
prec$emoji <- emoji('droplet')
prec$temp <- "prec"

maxmin_temps <- rbind(min_temps,max_temps)

# Temperatura máxima o mínima registrada y elevación
maxmin_temps %>% filter(elevacion<=1500) %>%
ggplot(aes(x=elevacion,y=t, label=emoji, color=emoji)) +
  geom_smooth()+
  scale_color_manual(values = c("darkgoldenrod2", "steelblue", "green"))+
  geom_text(family="EmojiOne", size=4, show.legend = FALSE) +
  labs(title="Temperatura máxima o mínima registrada y elevación", 
       subtitle = "Estaciones meteorológicas de la Cuenca del Río de la Plata", 
       caption="#Datosdemiercoles - @karbartolome", 
       x="Altura en metros sobre el nivel del mar", 
       y="Temperatura registrada (°C)")+
  theme_get()+
  facet_grid(rows=vars(emoji), scales="free_y")
  
# Precipitaciones y elevación
prec %>% filter(elevacion<=3000) %>%
  ggplot(aes(x=elevacion,y=t, label=emoji, color=emoji)) +
  geom_smooth(color="green")+
  scale_color_manual(values = c("steelblue"))+
  geom_text(family="EmojiOne", size=5, show.legend = F) +
  labs(title="Precipitaciones y elevación", 
       subtitle = "Estaciones meteorológicas de la Cuenca del Río de la Plata", 
       caption="#Datosdemiercoles - @karbartolome", 
       x="Altura en metros sobre el nivel del mar", 
       y="Milimetros acumulados")+
  theme_get()


#Datos para visualizar en rayshader
min_temp <- min_temps %>% slice(which.min(t)) 
max_temp <- max_temps %>% slice(which.max(t)) 
max_prec <- prec %>% slice(which.max(t)) 
min_prec <- prec %>% slice(which.min(t))
